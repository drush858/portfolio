<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout/main :: layout(
          ~{::content},
          ${pageTitle},
          ~{::head}
      )}">

<head></head>
<body>
<div th:fragment="content" class="space-y-10">

	<h2 class="text-2xl font-semibold mb-4"
	    th:text="'Cash Ledger – ' + ${account.name}">
	</h2>

	<div class="grid grid-cols-4 gap-4 mb-6 bg-gray-400 overflow-hidden rounded-2xl shadow border border-gray-200">
	  <div class="p-4 rounded shadow">
	    <p class="text-sm text-gray-800">Starting Balance</p>
	    <p class="text-xl font-semibold"
	       th:text="${summary.startingBalance}"></p>
	  </div>

	  <div class=" p-4 rounded shadow">
	    <p class="text-sm text-gray-800">Cash In</p>
	    <p class="text-xl text-green-700 font-semibold"
	       th:text="${summary.totalIn}"></p>
	  </div>

	  <div class=" p-4 rounded shadow">
	    <p class="text-sm text-gray-800">Cash Out</p>
	    <p class="text-xl text-red-700 font-semibold"
	       th:text="${summary.totalOut}"></p>
	  </div>

	  <div class=" p-4 rounded shadow">
	    <p class="text-sm text-gray-800">Current Balance</p>
	    <p class="text-xl text-blue-700 font-semibold"
	       th:text="${summary.currentBalance}"></p>
	  </div>
	</div>

	<button
	    type="button"
	    onclick="openDividendModal()"
	    class="mb-4 inline-flex items-center rounded-lg bg-green-600 px-4 py-2 border border-gray-200
	           text-sm font-semibold text-white hover:bg-green-700">
	    + Add Dividend
	</button>
	
	<button
	    type="button"
	    onclick="openCashModal()"
	    class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 border border-gray-200
	           text-sm font-semibold text-white hover:bg-blue-700">
	    + Add Cash
	</button>
	
	<button
	    type="button"
	    onclick="openWithdrawModal()"
	    class="mb-4 inline-flex items-center rounded-lg bg-red-600 px-4 py-2 border border-gray-200
	           text-sm font-semibold text-white hover:bg-red-700">
	    − Withdraw Cash
	</button>

	
	<div class="overflow-hidden rounded-2xl shadow border border-gray-200">
	<table class="min-w-full bg-gray-400 rounded rounded-2xl shadow border border-gray-200">
	  <thead class="bg-gray-400 text-left text-sm">
	    <tr>
	      <th class="px-4 py-2">Date</th>
	      <th class="px-4 py-2">Type</th>
	      <th class="px-4 py-2">Symbol</th>
	      <th class="px-4 py-2">Description</th>
	      <th class="px-4 py-2 text-right">Amount</th>
	      <th class="px-4 py-2 text-right">Balance</th>
		  <th class="px-4 py-2 text-right">Actions</th>
	    </tr>
	  </thead>

	  <tbody>
	    <tr th:each="row : ${transactions}"
	        class="border-t text-sm">

	      <td class="px-4 py-2"
	          th:text="${#temporals.format(row.date, 'MM-dd-yyyy')}"></td>

	      <td class="px-4 py-2 font-medium"
	          th:text="${row.type}"></td>

	      <td class="px-4 py-2"
	          th:text="${row.symbol ?: '-'}"></td>

	      <td class="px-4 py-2"
	          th:text="${row.description}"></td>

	      <td class="px-4 py-2 text-right font-mono"
	          th:classappend="${row.amount > 0} ? 'text-green-700' : 'text-red-700'"
	          th:text="${#numbers.formatCurrency(row.amount)}"></td>
			  
		  <td class="px-4 py-2 text-right font-mono"
		      th:text="${#numbers.formatCurrency(row.balance)}"></td>
	  
		  <!-- Actions -->
	      <td class="px-4 py-2 text-right">
	        <!-- If you have row.editable -->
	        <button type="button"
	                class="text-blue-800 hover:underline text-sm"
	                th:if="${row.editable}"
	                onclick="openCashEditModal(this)"
	                th:attr="
	                  data-id=${row.id},
	                  data-date=${#temporals.format(row.date, 'yyyy-MM-dd''T''HH:mm')},
	                  data-type=${row.type},
	                  data-symbol=${row.symbol},
	                  data-description=${row.description},
	                  data-amount=${row.amount}">
	          Edit
	        </button>

	        <span th:unless="${row.editable}"
	              class="text-xs text-gray-600">
	          Locked
	        </span>
			<!-- If you DON'T have row.editable yet, use this instead:
	        <button type="button"
	                class="text-blue-800 hover:underline text-sm"
	                onclick="openCashEditModal(this)"
	                th:attr="data-id=${row.id}, ...">
	           Edit
	        </button>
	        -->
	    </td>
			
	    </tr>
	  </tbody>
	</table>
	</div>
	
	<!-- Add Dividend Modal -->
	<div id="dividendModal"
	     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">

	    <div class="w-full max-w-md rounded-xl bg-gray-400 shadow-lg">
	        <!-- Header -->
	        <div class="flex items-center justify-between border-b px-6 py-4">
	            <h3 class="text-lg font-semibold text-gray-800">
	                Add Dividend
	            </h3>
	            <button onclick="closeDividendModal()"
	                    class="text-gray-400 hover:text-gray-600">
	                ✕
	            </button>
	        </div>

	        <!-- Form -->
	        <form th:action="@{/accounts/cash/dividend}"
	              method="post"
	              class="space-y-4 px-6 py-5">

	            <input type="hidden" name="accountId" th:value="${account.id}" />

	            <!-- Date -->
	            <div>
	                <label class="block text-sm font-medium text-gray-700">
	                    Date
	                </label>
	                <input type="date"
	                       name="transactionDate"
	                       th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
	                       required
	                       class="mt-1 w-full rounded-md border-gray-300
	                              focus:border-green-500 focus:ring-green-500" />
	            </div>

	            <!-- Symbol -->
	            <div>
	                <label class="block text-sm font-medium text-gray-700">
	                    Symbol (optional)
	                </label>
	                <select name="symbol"
	                        class="mt-1 w-full rounded-md border-gray-300
	                               focus:border-green-500 focus:ring-green-500">
	                    <option value="">— Cash Dividend —</option>
	                    <option th:each="s : ${symbols}"
	                            th:value="${s}"
	                            th:text="${s}">
	                    </option>
	                </select>
	            </div>

	            <!-- Amount -->
	            <div>
	                <label class="block text-sm font-medium text-gray-700">
	                    Amount
	                </label>
	                <input type="number"
	                       name="amount"
	                       step="0.01"
	                       min="0.01"
	                       placeholder="0.00"
	                       required
	                       class="mt-1 w-full rounded-md border-gray-300
	                              focus:border-green-500 focus:ring-green-500" />
	            </div>

	            <!-- Notes -->
	            <div>
	                <label class="block text-sm font-medium text-gray-700">
	                    Description
	                </label>
	                <input type="text"
	                       name="description"
	                       placeholder="Quarterly dividend"
	                       class="mt-1 w-full rounded-md border-gray-300
	                              focus:border-green-500 focus:ring-green-500" />
	            </div>

	            <!-- Actions -->
	            <div class="flex justify-end gap-3 border-t pt-4">
	                <button type="button"
	                        onclick="closeDividendModal()"
	                        class="rounded-md border px-4 py-2 text-sm
	                               text-gray-600 hover:bg-gray-100">
	                    Cancel
	                </button>
	                <button type="submit"
	                        class="rounded-md bg-green-600 px-4 py-2 text-sm
	                               font-semibold text-white hover:bg-green-700">
	                    Save Dividend
	                </button>
	            </div>
	        </form>
	    </div>
	</div>
	
	<!-- Add Cash Modal -->
	<div id="cashModal"
	     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">

	    <div class="w-full max-w-md rounded-xl bg-gray-400 shadow-lg">

	        <div class="flex items-center justify-between border-b px-6 py-4">
	            <h3 class="text-lg font-semibold text-gray-800">
	                Add Cash
	            </h3>
	            <button onclick="closeCashModal()"
	                    class="text-gray-400 hover:text-gray-600">✕</button>
	        </div>

	        <form th:action="@{/accounts/cash/add}" method="post"
	              class="space-y-4 px-6 py-5">

	            <input type="hidden" name="accountId" th:value="${account.id}" />

	            <!-- Date -->
	            <div>
	                <label class="block text-sm font-medium text-gray-700">Date</label>
	                <input type="date" name="transactionDate" required
					       th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
	                       class="mt-1 w-full rounded-md border-gray-300
	                              focus:border-blue-500 focus:ring-blue-500" />
	            </div>

	            <!-- Type -->
	            <div>
	                <label class="block text-sm font-medium text-gray-700">
	                    Type
	                </label>
	                <select name="type" required
	                        class="mt-1 w-full rounded-md border-gray-300
	                               focus:border-blue-500 focus:ring-blue-500">
	                    <option value="OPENING_BALANCE">Opening Balance</option>
	                    <option value="TRANSFER_IN">Deposit / Adjustment</option>
	                </select>
	            </div>

	            <!-- Amount -->
	            <div>
	                <label class="block text-sm font-medium text-gray-700">
	                    Amount
	                </label>
	                <input type="number" name="amount" step="0.01" min="0.01"
	                       placeholder="0.00" required
	                       class="mt-1 w-full rounded-md border-gray-300
	                              focus:border-blue-500 focus:ring-blue-500" />
	            </div>

	            <!-- Notes -->
	            <div>
	                <label class="block text-sm font-medium text-gray-700">
	                    Description
	                </label>
	                <input type="text" name="Description"
	                       placeholder="Initial funding"
	                       class="mt-1 w-full rounded-md border-gray-300
	                              focus:border-blue-500 focus:ring-blue-500" />
	            </div>

	            <div class="flex justify-end gap-3 border-t pt-4">
	                <button type="button" onclick="closeCashModal()"
	                        class="rounded-md border px-4 py-2 text-sm
	                               text-gray-600 hover:bg-gray-100">
	                    Cancel
	                </button>
	                <button type="submit"
	                        class="rounded-md bg-blue-600 px-4 py-2 text-sm
	                               font-semibold text-white hover:bg-blue-700">
	                    Save
	                </button>
	            </div>
	        </form>
	    </div>
	</div>
	
	<!-- Withdraw Cash Modal -->
	<div id="withdrawModal"
	     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">

	  <div class="w-full max-w-md rounded-xl bg-gray-400 shadow-lg">

	    <!-- Header -->
	    <div class="flex items-center justify-between border-b px-6 py-4">
	      <h3 class="text-lg font-semibold text-gray-800">
	        Withdraw Cash
	      </h3>
	      <button onclick="closeWithdrawModal()"
	              class="text-gray-400 hover:text-gray-600">✕</button>
	    </div>

	    <!-- Form -->
	    <form th:action="@{/accounts/cash/withdraw}" method="post"
	          class="space-y-4 px-6 py-5">

	      <input type="hidden" name="accountId" th:value="${account.id}" />

	      <!-- Date -->
	      <div>
	        <label class="block text-sm font-medium text-gray-700">Date</label>
	        <input type="date"
	               name="transactionDate"
	               required
				   th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
	               class="mt-1 w-full rounded-md border-gray-300
	                      focus:border-red-500 focus:ring-red-500" />
	      </div>

	      <!-- Amount -->
	      <div>
	        <label class="block text-sm font-medium text-gray-700">
	          Amount
	        </label>
	        <input type="number"
	               name="amount"
	               step="0.01"
	               min="0.01"
	               required
	               placeholder="0.00"
	               class="mt-1 w-full rounded-md border-gray-300
	                      focus:border-red-500 focus:ring-red-500" />
	      </div>

	      <!-- Notes -->
	      <div>
	        <label class="block text-sm font-medium text-gray-700">
	          Notes
	        </label>
	        <input type="text"
	               name="description"
	               placeholder="Transfer to checking"
	               class="mt-1 w-full rounded-md border-gray-300
	                      focus:border-red-500 focus:ring-red-500" />
	      </div>

	      <!-- Actions -->
	      <div class="flex justify-end gap-3 border-t pt-4">
	        <button type="button"
	                onclick="closeWithdrawModal()"
	                class="rounded-md border px-4 py-2 text-sm
	                       text-gray-600 hover:bg-gray-100">
	          Cancel
	        </button>
	        <button type="submit"
	                class="rounded-md bg-red-600 px-4 py-2 text-sm
	                       font-semibold text-white hover:bg-red-700">
	          Withdraw
	        </button>
	      </div>
	    </form>

	  </div>
	</div>

	<!-- Edit Cash Transaction Modal -->
	<div id="cashEditModal"
	     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">

	  <div class="w-full max-w-lg rounded-2xl bg-white shadow-lg">

	    <div class="flex items-center justify-between border-b px-6 py-4">
	      <h3 class="text-lg font-semibold text-gray-800">Edit Cash Transaction</h3>
	      <button type="button"
	              onclick="closeCashEditModal()"
	              class="text-gray-400 hover:text-gray-600">✕</button>
	    </div>

	    <form th:action="@{/accounts/cash/edit}" method="post" class="space-y-4 px-6 py-5">

	      <!-- you already have accountId on the page -->
	      <input type="hidden" name="accountId" th:value="${account.id}" />
	      <input type="hidden" name="id"        id="editId" />

	      <div>
	        <label class="block text-sm font-medium text-gray-700">Date</label>
			<input id="editDate" type="datetime-local" name="transactionDate" required
			       class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2
			              focus:border-blue-500 focus:ring-blue-500" />
	      </div>

	      <div>
	        <label class="block text-sm font-medium text-gray-700">Type</label>
	        <select id="editType" name="transactionType" required
	                class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2
	                       focus:border-blue-500 focus:ring-blue-500">
	          <option th:each="t : ${T(dr.portfolio.domain.CashTransactionType).values()}"
	                  th:value="${t}" th:text="${t}"></option>
	        </select>
	      </div>

	      <div>
	        <label class="block text-sm font-medium text-gray-700">Symbol</label>
	        <input id="editSymbol" type="text" name="symbol"
	               class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 font-mono
	                      focus:border-blue-500 focus:ring-blue-500"
	               placeholder="Optional" />
	      </div>

	      <div>
	        <label class="block text-sm font-medium text-gray-700">Description</label>
	        <input id="editDescription" type="text" name="description"
	               class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2
	                      focus:border-blue-500 focus:ring-blue-500"
	               placeholder="Optional" />
	      </div>

	      <div>
	        <label class="block text-sm font-medium text-gray-700">Amount</label>
	        <input id="editAmount" type="number" name="amount" step="0.01"
	               class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 font-mono
	                      focus:border-blue-500 focus:ring-blue-500"
	               placeholder="0.00" />
	        <p class="mt-1 text-xs text-gray-600">
	          Tip: if your service applies sign rules (BUY/FEE negative, etc.), enter a positive number.
	        </p>
	      </div>

	      <div class="flex justify-end gap-3 border-t pt-4">
	        <button type="button"
	                onclick="closeCashEditModal()"
	                class="rounded-md border px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
	          Cancel
	        </button>

	        <button type="submit"
	                class="rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700">
	          Save Changes
	        </button>
	      </div>

	    </form>
	  </div>
	</div>

	
	<script>
	    function openDividendModal() {
	        document.getElementById('dividendModal').classList.remove('hidden');
	        document.getElementById('dividendModal').classList.add('flex');
	    }

	    function closeDividendModal() {
	        const modal = document.getElementById('dividendModal');
	        modal.classList.add('hidden');
	        modal.classList.remove('flex');
	    }
		
		function openCashModal() {
		    const m = document.getElementById('cashModal');
		    m.classList.remove('hidden');
		    m.classList.add('flex');
		}

		function closeCashModal() {
		    const m = document.getElementById('cashModal');
		    m.classList.add('hidden');
		    m.classList.remove('flex');
		}
		
		function openWithdrawModal() {
		    const modal = document.getElementById('withdrawModal');
		    modal.classList.remove('hidden');
		    modal.classList.add('flex');
		}

		function closeWithdrawModal() {
		    const modal = document.getElementById('withdrawModal');
		    modal.classList.add('hidden');
		    modal.classList.remove('flex');
		}
		
		function openCashEditModal(btn) {
		    const m = document.getElementById('cashEditModal');

		    document.getElementById('editId').value = btn.dataset.id || '';
		    document.getElementById('editDate').value = btn.dataset.date || '';
		    document.getElementById('editType').value = btn.dataset.type || '';
		    document.getElementById('editSymbol').value = btn.dataset.symbol || '';
		    document.getElementById('editDescription').value = btn.dataset.description || '';
		    document.getElementById('editAmount').value = btn.dataset.amount || '';

		    m.classList.remove('hidden');
		    m.classList.add('flex');
		}

		function closeCashEditModal() {
		    const m = document.getElementById('cashEditModal');
		    m.classList.add('hidden');
		    m.classList.remove('flex');
		}
		
	</script>
	
</div>
</body>
</html>